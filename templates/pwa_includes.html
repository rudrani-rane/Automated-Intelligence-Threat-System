<!-- PWA Installation and Service Worker Registration Script -->
<script>
// Register Service Worker for PWA functionality
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/sw.js')
            .then((registration) => {
                console.log('[PWA] Service Worker registered:', registration.scope);
                
                // Check for updates periodically
                setInterval(() => {
                    registration.update();
                }, 60000); // Check every minute
            })
            .catch((error) => {
                console.error('[PWA] Service Worker registration failed:', error);
            });
    });
    
    // Handle service worker updates
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('[PWA] Service Worker updated, reloading...');
        window.location.reload();
    });
}

// PWA Install Prompt
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
    console.log('[PWA] Install prompt available');
    
    // Prevent default install prompt
    e.preventDefault();
    deferredPrompt = e;
    
    // Show custom install button/banner
    showInstallPromotion();
});

function showInstallPromotion() {
    // Create install banner
    const banner = document.createElement('div');
    banner.id = 'pwa-install-banner';
    banner.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #00bfff 0%, #0066ff 100%);
        color: #000;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,191,255,0.4);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 16px;
        font-family: var(--font-orbitron);
        animation: slideUp 0.3s ease;
    `;
    
    banner.innerHTML = `
        <div>
            <div style="font-weight: 700; margin-bottom: 4px;">Install ATIS</div>
            <div style="font-size: 0.875rem; opacity: 0.9;">Add to your home screen for quick access</div>
        </div>
        <button id="pwa-install-btn" style="
            background: #000;
            color: #00bfff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
        ">Install</button>
        <button id="pwa-dismiss-btn" style="
            background: transparent;
            color: #000;
            border: 1px solid #000;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
        ">Not Now</button>
    `;
    
    document.body.appendChild(banner);
    
    // Install button handler
    document.getElementById('pwa-install-btn').addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const result = await deferredPrompt.userChoice;
            
            console.log('[PWA] Install prompt result:', result.outcome);
            
            if (result.outcome === 'accepted') {
                console.log('[PWA] User accepted install');
            }
            
            deferredPrompt = null;
            banner.remove();
        }
    });
    
    // Dismiss button handler
    document.getElementById('pwa-dismiss-btn').addEventListener('click', () => {
        banner.remove();
        // Remember dismissal for 7 days
        localStorage.setItem('pwa-install-dismissed', Date.now());
    });
    
    // Check if recently dismissed
    const dismissed = localStorage.getItem('pwa-install-dismissed');
    if (dismissed && (Date.now() - parseInt(dismissed) < 7 * 24 * 60 * 60 * 1000)) {
        banner.remove();
    }
}

// Detect installed state
window.addEventListener('appinstalled', () => {
    console.log('[PWA] App installed successfully');
    deferredPrompt = null;
    
    // Show success message
    if (wsClient && wsClient.showNotification) {
        wsClient.showNotification(
            'âœ… ATIS Installed',
            'App installed successfully! Launch from your home screen.',
            'info'
        );
    }
});

// Detect if running as PWA
function isPWA() {
    return window.matchMedia('(display-mode: standalone)').matches ||
           window.navigator.standalone === true;
}

if (isPWA()) {
    console.log('[PWA] Running as installed app');
    document.body.classList.add('pwa-mode');
}

// Add CSS animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideUp {
        from {
            transform: translateX(-50%) translateY(100px);
            opacity: 0;
        }
        to {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    }
`;
document.head.appendChild(style);
</script>

<!-- Manifest Link -->
<link rel="manifest" href="/static/manifest.json">

<!-- iOS PWA Meta Tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ATIS">

<!-- Theme Colors -->
<meta name="theme-color" content="#00bfff">
<meta name="msapplication-TileColor" content="#00bfff">

<!-- Link Responsive CSS -->
<link rel="stylesheet" href="/static/css/responsive.css">
