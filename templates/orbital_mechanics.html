<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Mechanics - ATIS</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
    <style>
        .oe-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.2rem;margin-bottom:1.5rem}
        .oe-input{display:flex;flex-direction:column;gap:5px}
        .oe-input label{color:rgba(255,255,255,.7);font-size:.8rem;font-family:'Roboto Mono',monospace}
        .oe-input input{padding:.6rem .8rem;background:rgba(0,0,0,.5);border:1px solid rgba(0,212,255,.3);border-radius:4px;color:#fff;font-family:'Roboto Mono',monospace;font-size:.9rem}
        .oe-input input:focus{outline:none;border-color:#00d4ff;box-shadow:0 0 6px rgba(0,212,255,.3)}
        .result-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06);font-family:'Roboto Mono',monospace;font-size:.85rem}
        .result-val{color:#00d4ff;font-weight:700}
        .newton-step{padding:8px 12px;margin-bottom:4px;background:rgba(0,212,255,.04);border-left:3px solid rgba(0,212,255,.4);border-radius:2px;font-family:'Roboto Mono',monospace;font-size:.8rem}
        .eq-box{background:rgba(0,0,0,.4);border:1px solid rgba(0,212,255,.2);border-radius:6px;padding:1rem;margin-bottom:1rem;font-family:'Roboto Mono',monospace;font-size:.82rem;line-height:1.7}
        .preset-btn{padding:.4rem .9rem;border:1px solid rgba(0,212,255,.4);background:rgba(0,212,255,.08);color:#00d4ff;border-radius:4px;cursor:pointer;font-size:.78rem;font-family:'Orbitron',monospace}
        .preset-btn:hover{background:rgba(0,212,255,.2)}
    </style>
</head>
<body>
<nav class="navbar"><div class="nav-content"><div class="logo">&#x1F6F0;&#xFE0F; ATIS</div>
    <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/galaxy">Galaxy</a></li>
                <li><a href="/radar">Radar</a></li>
                <li><a href="/watchlist">Watchlist</a></li>
                <li><a href="/trajectory">Trajectory</a></li>
                <li><a href="/timeline">Timeline</a></li>
                <li><a href="/analytics">Analytics</a></li>
                <li><a href="/multi-view">Multi-View</a></li>
                <li><a href="/ml-dashboard">ML</a></li>
                <li><a href="/orbital-mechanics" class="active">Orbital</a></li>
                <li><a href="/impact-calculator">Impact Calc</a></li>
                <li><a href="/nbody">N-Body</a></li>
                <li><a href="/alerts">Alerts</a></li>
                <li><a href="/trends">Trends</a></li>
                <li><a href="/comparison">Compare</a></li>
            </ul>
</div></nav>

<div class="container" style="margin-top:100px">
    <div style="text-align:center;margin-bottom:40px">
        <h1>Orbital Mechanics Engine</h1>
        <p style="color:rgba(255,255,255,.8)">Newton-Raphson Kepler Solver &bull; Vis-viva Equation &bull; 3D Keplerian Orbit Visualizer</p>
    </div>

    <!-- Equations reference -->
    <div class="card" style="margin-bottom:2rem">
        <div class="card-header"><h3 class="card-title">&#x1F4D0; Governing Equations</h3></div>
        <div class="card-body">
            <div class="grid grid-3">
                <div class="eq-box">
                    <b style="color:#00d4ff">Kepler's Equation</b><br>
                    M = E &minus; e&sdot;sin(E)<br>
                    where M = mean anomaly<br>
                    E = eccentric anomaly<br>
                    Newton-Raphson: E<sub>n+1</sub> = E<sub>n</sub> + (M &minus; E<sub>n</sub> + e&sdot;sin(E<sub>n</sub>)) / (1 &minus; e&sdot;cos(E<sub>n</sub>))
                </div>
                <div class="eq-box">
                    <b style="color:#ffa500">Vis-viva Equation</b><br>
                    v = &radic;[GM(2/r &minus; 1/a)]<br>
                    where G = 6.674&times;10<sup>-11</sup> Nm&sup2;/kg&sup2;<br>
                    M = 1.989&times;10<sup>30</sup> kg<br>
                    v<sub>esc</sub> = &radic;(2GM/r)
                </div>
                <div class="eq-box">
                    <b style="color:#00ff7f">Orbital Period (Kepler 3rd)</b><br>
                    T = 2&pi;&radic;(a&sup3;/GM)<br>
                    T[yr] = a<sup>3/2</sup> [AU]<br>
                    <b style="color:#ffa500">True Anomaly from E:</b><br>
                    tan(&nu;/2) = &radic;((1+e)/(1&minus;e)) &sdot; tan(E/2)
                </div>
            </div>
        </div>
    </div>

    <!-- Presets -->
    <div style="margin-bottom:1.5rem;display:flex;gap:.7rem;flex-wrap:wrap">
        <button class="preset-btn" onclick="loadPreset('apophis')">Apophis</button>
        <button class="preset-btn" onclick="loadPreset('bennu')">Bennu</button>
        <button class="preset-btn" onclick="loadPreset('halley')">Halley's Comet</button>
        <button class="preset-btn" onclick="loadPreset('eros')">Eros</button>
        <button class="preset-btn" onclick="loadPreset('earth')">Earth</button>
        <button class="preset-btn" onclick="loadPreset('custom')">Random NEO</button>
    </div>

    <!-- Inputs -->
    <div class="card" style="margin-bottom:2rem">
        <div class="card-header"><h3 class="card-title">&#x1F4D0; Orbital Elements Input</h3></div>
        <div class="card-body">
            <div class="oe-grid">
                <div class="oe-input"><label>Semi-major axis a (AU)</label>
                    <input id="oe_a" type="number" step="0.0001" value="0.9224" min="0.01" max="100"></div>
                <div class="oe-input"><label>Eccentricity e (0–1)</label>
                    <input id="oe_e" type="number" step="0.0001" value="0.1912" min="0" max="0.9999"></div>
                <div class="oe-input"><label>Inclination i ()</label>
                    <input id="oe_i" type="number" step="0.01" value="3.34" min="0" max="180"></div>
                <div class="oe-input"><label>Long. Ascending Node Ω ()</label>
                    <input id="oe_om" type="number" step="0.01" value="203.9" min="0" max="360"></div>
                <div class="oe-input"><label>Arg. Perihelion ω ()</label>
                    <input id="oe_w" type="number" step="0.01" value="126.7" min="0" max="360"></div>
                <div class="oe-input"><label>Mean Anomaly M ()</label>
                    <input id="oe_m" type="number" step="1" value="0" min="0" max="360"></div>
            </div>
            <button onclick="compute()" style="padding:.75rem 2rem;background:#00d4ff;color:#000;border:none;border-radius:4px;cursor:pointer;font-family:'Orbitron',monospace;font-weight:700;font-size:.9rem">
                 Compute Orbit
            </button>
        </div>
    </div>

    <!-- Results -->
    <div class="grid grid-2" style="margin-bottom:2rem">
        <div class="card">
            <div class="card-header"><h3 class="card-title">Computed Results</h3></div>
            <div class="card-body" id="resultsDiv" style="font-family:'Roboto Mono',monospace"></div>
        </div>
        <div class="card">
            <div class="card-header"><h3 class="card-title">Newton-Raphson Iteration Log</h3></div>
            <div class="card-body" id="newtonLog" style="max-height:300px;overflow-y:auto"></div>
        </div>
    </div>

    <!-- Orbit chart + velocity -->
    <div class="grid grid-2" style="margin-bottom:2rem">
        <div class="card">
            <div class="card-header"><h3 class="card-title">3D Orbit Visualization</h3></div>
            <div id="orbitPlot3D" style="width:100%;height:420px"></div>
        </div>
        <div class="card">
            <div class="card-header"><h3 class="card-title">Velocity Profile (vis-viva)</h3></div>
            <div id="velocityPlot" style="width:100%;height:420px"></div>
        </div>
    </div>

    <!-- Energy + angular momentum -->
    <div class="grid grid-3" style="margin-bottom:2rem">
        <div class="card">
            <div class="card-header"><h3 class="card-title">Energy</h3></div>
            <div class="card-body" id="energyDiv"></div>
        </div>
        <div class="card">
            <div class="card-header"><h3 class="card-title"> Angular Momentum</h3></div>
            <div class="card-body" id="angMomDiv"></div>
        </div>
        <div class="card">
            <div class="card-header"><h3 class="card-title"> Radial Distance Profile</h3></div>
            <div id="radialPlot" style="height:200px"></div>
        </div>
    </div>
</div>

<script>
const AU = 1.496e11, MU=1.32712440018e20, DEG=Math.PI/180;
const DARKLAY={paper_bgcolor:"rgba(0,0,0,0)",plot_bgcolor:"rgba(10,10,20,.9)",
    font:{family:"Roboto Mono,monospace",color:"#00d4ff",size:11},
    xaxis:{gridcolor:"rgba(0,212,255,.1)",color:"#fff"},
    yaxis:{gridcolor:"rgba(0,212,255,.1)",color:"#fff"},
    margin:{l:50,r:20,t:30,b:50}};

const PRESETS = {
    apophis:{a:0.9224,e:0.1912,i:3.34,om:203.9,w:126.7,m:0},
    bennu:{a:1.1264,e:0.2037,i:6.03,om:2.06,w:66.22,m:0},
    halley:{a:17.74,e:0.967,i:162.3,om:58.42,w:111.3,m:180},
    eros:{a:1.458,e:0.223,i:10.83,om:304.4,w:178.9,m:0},
    earth:{a:1.0,e:0.0167,i:0.00,om:174.9,w:288.1,m:0},
    custom:{a:(Math.random()*.8+0.8).toFixed(4),e:(Math.random()*.35+0.05).toFixed(4),i:(Math.random()*30).toFixed(2),om:(Math.random()*360).toFixed(1),w:(Math.random()*360).toFixed(1),m:0}
};

function loadPreset(name){
    const p=PRESETS[name];
    ['a','e','i','om','w','m'].forEach(k=>{document.getElementById('oe_'+k).value=p[k]});
    compute();
}

function solveKepler(M_deg,e){
    let M=M_deg*DEG, E=M;
    const log=[];
    for(let n=0;n<50;n++){
        const f=M-E+e*Math.sin(E);
        const df=-(1-e*Math.cos(E));
        const dE=-f/df;
        log.push({n,E_rad:E,dE,residual:Math.abs(f)});
        E+=dE;
        if(Math.abs(dE)<1e-14)break;
    }
    return{E,log};
}

function keplerianState(a,e,i_deg,om_deg,w_deg,M_deg){
    const {E,log}=solveKepler(M_deg,e);
    const nu=2*Math.atan2(Math.sqrt(1+e)*Math.sin(E/2),Math.sqrt(1-e)*Math.cos(E/2));
    const r_au=a*(1-e*Math.cos(E));
    const r_m=r_au*AU;
    const i=i_deg*DEG,om=om_deg*DEG,w=w_deg*DEG;
    const cosO=Math.cos(om),sinO=Math.sin(om),cosI=Math.cos(i),sinI=Math.sin(i),
          cosW=Math.cos(w),sinW=Math.sin(w);
    const xp=r_au*Math.cos(nu),yp=r_au*Math.sin(nu);
    const x=(cosO*cosW-sinO*sinW*cosI)*xp+(-cosO*sinW-sinO*cosW*cosI)*yp;
    const y=(sinO*cosW+cosO*sinW*cosI)*xp+(-sinO*sinW+cosO*cosW*cosI)*yp;
    const z=(sinW*sinI)*xp+(cosW*sinI)*yp;
    const v2=MU*(2/r_m-1/(a*AU));
    const v_km=v2>0?Math.sqrt(v2)/1000:0;
    const v_esc=Math.sqrt(2*MU/r_m)/1000;
    const T_yr=Math.pow(a,1.5);
    const h=Math.sqrt(MU*a*AU*(1-e*e)); // specific ang momentum
    const E_sp=-MU/(2*a*AU); // specific orbital energy
    return{E_ecc:E,nu_deg:nu/DEG,r_au,x,y,z,v_km,v_esc,T_yr,h,E_sp,log};
}

function orbitPath(a,e,i_deg,om_deg,w_deg){
    const pts=[];
    for(let k=0;k<=360;k++){
        const{x,y,z}=keplerianState(a,e,i_deg,om_deg,w_deg,k);
        pts.push({x,y,z});
    }
    return pts;
}

function compute(){
    const a=parseFloat(document.getElementById('oe_a').value);
    const e=parseFloat(document.getElementById('oe_e').value);
    const i=parseFloat(document.getElementById('oe_i').value);
    const om=parseFloat(document.getElementById('oe_om').value);
    const w=parseFloat(document.getElementById('oe_w').value);
    const M=parseFloat(document.getElementById('oe_m').value);
    if(e>=1){alert("Eccentricity must be < 1 for elliptical orbits");return;}

    const st=keplerianState(a,e,i,om,w,M);
    const q=a*(1-e),Q=a*(1+e);

    // Results
    const rows=[
        ["Eccentric Anomaly E",st.E_ecc.toFixed(8)+" rad"],
        ["True Anomaly ν",st.nu_deg.toFixed(4)+""],
        ["Radial Distance r",st.r_au.toFixed(6)+" AU = "+(st.r_au*1.496e8).toFixed(0)+" km"],
        ["Position (x,y,z)",`${st.x.toFixed(4)}, ${st.y.toFixed(4)}, ${st.z.toFixed(4)} AU`],
        ["Orbital Speed v",st.v_km.toFixed(4)+" km/s"],
        ["Escape Speed v_esc",st.v_esc.toFixed(4)+" km/s"],
        ["Orbital Period T",st.T_yr.toFixed(4)+" yr = "+(st.T_yr*365.25).toFixed(1)+" days"],
        ["Perihelion q",q.toFixed(6)+" AU"],
        ["Aphelion Q",Q.toFixed(6)+" AU"],
        ["Semi-latus rectum p",`${(a*(1-e*e)).toFixed(6)} AU`]
    ];
    document.getElementById('resultsDiv').innerHTML=rows.map(([k,v])=>
        `<div class="result-row"><span style="color:rgba(255,255,255,.7)">${k}</span><span class="result-val">${v}</span></div>`).join("");

    // Newton log
    document.getElementById('newtonLog').innerHTML=st.log.map(s=>
        `<div class="newton-step">Iter ${s.n}: E = ${s.E_rad.toFixed(8)} &nbsp; ΔE = ${s.dE.toExponential(4)} &nbsp; |f| = ${s.residual.toExponential(4)}</div>`).join("");

    // Energy & angular momentum
    const Emj=st.E_sp/1e6;
    document.getElementById('energyDiv').innerHTML=`
        <div class="result-row"><span style="color:rgba(255,255,255,.7)">Specific Orbital Energy</span><span class="result-val">${Emj.toExponential(4)} MJ/kg</span></div>
        <div class="result-row"><span style="color:rgba(255,255,255,.7)">Binding Energy</span><span class="result-val">${(-Emj).toExponential(4)} MJ/kg</span></div>
        <div class="result-row"><span style="color:rgba(255,255,255,.7)">Type</span><span class="result-val" style="color:#00ff7f">Elliptical (e&lt;1)</span></div>`;
    document.getElementById('angMomDiv').innerHTML=`
        <div class="result-row"><span style="color:rgba(255,255,255,.7)">Specific Ang. Mom. h</span><span class="result-val">${(st.h/1e9).toExponential(4)} km/s</span></div>
        <div class="result-row"><span style="color:rgba(255,255,255,.7)">h = (GMp)</span><span class="result-val">${(st.h/1e9).toFixed(0)} km/s</span></div>
        <div class="result-row"><span style="color:rgba(255,255,255,.7)">Semi-latus rectum p</span><span class="result-val">${(a*(1-e*e)).toFixed(6)} AU</span></div>`;

    // 3D orbit
    const path=orbitPath(a,e,i,om,w);
    const earthPath=[];
    for(let k=0;k<=360;k++) earthPath.push({x:Math.cos(k*DEG),y:Math.sin(k*DEG),z:0});
    Plotly.newPlot('orbitPlot3D',[
        {x:earthPath.map(p=>p.x),y:earthPath.map(p=>p.y),z:earthPath.map(p=>p.z),
         mode:"lines",type:"scatter3d",name:"Earth",line:{color:"#2255ff",width:2}},
        {x:path.map(p=>p.x),y:path.map(p=>p.y),z:path.map(p=>p.z),
         mode:"lines",type:"scatter3d",name:"Orbit",line:{color:"#00d4ff",width:3}},
        {x:[st.x],y:[st.y],z:[st.z],mode:"markers",type:"scatter3d",name:"Object",
         marker:{color:"#ff3333",size:8,symbol:"circle"}},
        {x:[0],y:[0],z:[0],mode:"markers",type:"scatter3d",name:"Sun",
         marker:{color:"#ffd700",size:14}},
        {x:[path[0].x],y:[path[0].y],z:[path[0].z],mode:"markers",type:"scatter3d",name:"Perihelion",
         marker:{color:"#00ff7f",size:6}},
        {x:[path[180].x],y:[path[180].y],z:[path[180].z],mode:"markers",type:"scatter3d",name:"Aphelion",
         marker:{color:"#ffa500",size:6}}
    ],{...DARKLAY,
       scene:{xaxis:{title:"X (AU)",color:"#fff",gridcolor:"#111"},
              yaxis:{title:"Y (AU)",color:"#fff",gridcolor:"#111"},
              zaxis:{title:"Z (AU)",color:"#fff",gridcolor:"#111"},bgcolor:"rgba(0,0,0,0)"},
       margin:{l:0,r:0,t:20,b:0},showlegend:true,
       legend:{font:{color:"#fff"},bgcolor:"rgba(0,0,0,.5)"}},{responsive:true});

    // Velocity profile
    const Marr=Array.from({length:361},(_,k)=>k);
    const vArr=Marr.map(m_deg=>{
        const{r_au}=keplerianState(a,e,i,om,w,m_deg);
        const v2=MU*(2/(r_au*AU)-1/(a*AU));
        return v2>0?Math.sqrt(v2)/1000:0;
    });
    const rArr=Marr.map(m_deg=>keplerianState(a,e,i,om,w,m_deg).r_au);
    Plotly.newPlot('velocityPlot',[
        {x:Marr,y:vArr,mode:"lines",type:"scatter",name:"Speed (km/s)",
         line:{color:"#ff00ff",width:2},fill:"tozeroy",fillcolor:"rgba(255,0,255,.07)"},
        {x:Marr,y:Array(361).fill(11.19),mode:"lines",name:"Earth Escape (11.19 km/s)",
         line:{color:"rgba(255,255,255,.3)",dash:"dash"}}
    ],{...DARKLAY,xaxis:{...DARKLAY.xaxis,title:"Mean Anomaly M ()"},
       yaxis:{...DARKLAY.yaxis,title:"Speed (km/s)"},showlegend:true,
       legend:{font:{color:"#fff"},bgcolor:"rgba(0,0,0,.5)"}},{responsive:true});

    // Radial plot
    Plotly.newPlot('radialPlot',[
        {x:Marr,y:rArr,mode:"lines",type:"scatter",name:"r(M)",
         line:{color:"#00d4ff",width:2},fill:"tozeroy",fillcolor:"rgba(0,212,255,.07)"},
        {x:Marr,y:Array(361).fill(1),mode:"lines",name:"1 AU",
         line:{color:"rgba(255,165,0,.4)",dash:"dot"}}
    ],{...DARKLAY,xaxis:{...DARKLAY.xaxis,title:"M ()"},
       yaxis:{...DARKLAY.yaxis,title:"r (AU)"},
       margin:{l:45,r:10,t:10,b:40},showlegend:false},{responsive:true,displayModeBar:false});
}

// Boot
compute();
</script>
</body>
</html>
