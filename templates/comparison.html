<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asteroid Comparison - ATIS</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">üõ∞Ô∏è ATIS</div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/galaxy">Galaxy</a></li>
                <li><a href="/radar">Radar</a></li>
                <li><a href="/watchlist">Watchlist</a></li>
                <li><a href="/trajectory">Trajectory</a></li>
                <li><a href="/timeline">Timeline</a></li>
                <li><a href="/analytics">Analytics</a></li>
                <li><a href="/multi-view">Multi-View</a></li>
                <li><a href="/ml-dashboard">ML</a></li>
                <li><a href="/orbital-mechanics">Orbital</a></li>
                <li><a href="/impact-calculator">Impact Calc</a></li>
                <li><a href="/nbody">N-Body</a></li>
                <li><a href="/alerts">Alerts</a></li>
                <li><a href="/trends">Trends</a></li>
                <li><a href="/comparison" class="active">Compare</a></li>
            </ul>
        </div>
    </nav>

    <div class="container" style="padding-top: 80px;">
        <div class="page-header">
            <h1>Asteroid Comparison Tool</h1>
            <p>Side-by-side comparison of multiple Near-Earth Objects</p>
        </div>

        <!-- Selection Panel -->
        <div class="comparison-selector">
            <div class="selector-slot">
                <h3>Asteroid A</h3>
                <input type="text" id="searchA" placeholder="Search asteroid..." class="search-input">
                <div id="resultsA" class="search-results"></div>
                <div id="selectedA" class="selected-asteroid">
                    <p>No asteroid selected</p>
                </div>
            </div>

            <div class="selector-slot">
                <h3>Asteroid B</h3>
                <input type="text" id="searchB" placeholder="Search asteroid..." class="search-input">
                <div id="resultsB" class="search-results"></div>
                <div id="selectedB" class="selected-asteroid">
                    <p>No asteroid selected</p>
                </div>
            </div>

            <div class="selector-slot">
                <h3>Asteroid C (Optional)</h3>
                <input type="text" id="searchC" placeholder="Search asteroid..." class="search-input">
                <div id="resultsC" class="search-results"></div>
                <div id="selectedC" class="selected-asteroid">
                    <p>No asteroid selected</p>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button id="compareBtn" class="btn btn-primary" disabled>Compare Selected Asteroids</button>
            <button id="clearBtn" class="btn btn-secondary">Clear All</button>
        </div>

        <!-- Comparison Results -->
        <div id="comparisonResults" style="display: none;">
            <!-- Basic Properties Comparison Table -->
            <div class="comparison-section">
                <h2>Basic Properties</h2>
                <div class="comparison-table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Property</th>
                                <th id="headerA">Asteroid A</th>
                                <th id="headerB">Asteroid B</th>
                                <th id="headerC" style="display: none;">Asteroid C</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Name</strong></td>
                                <td id="nameA">-</td>
                                <td id="nameB">-</td>
                                <td id="nameC" style="display: none;">-</td>
                            </tr>
                            <tr>
                                <td><strong>SPKID</strong></td>
                                <td id="spkidA">-</td>
                                <td id="spkidB">-</td>
                                <td id="spkidC" style="display: none;">-</td>
                            </tr>
                            <tr>
                                <td><strong>Threat Score</strong></td>
                                <td id="threatA">-</td>
                                <td id="threatB">-</td>
                                <td id="threatC" style="display: none;">-</td>
                            </tr>
                            <tr>
                                <td><strong>PHA Status</strong></td>
                                <td id="phaA">-</td>
                                <td id="phaB">-</td>
                                <td id="phaC" style="display: none;">-</td>
                            </tr>
                            <tr>
                                <td><strong>MOID (AU)</strong></td>
                                <td id="moidA">-</td>
                                <td id="moidB">-</td>
                                <td id="moidC" style="display: none;">-</td>
                            </tr>
                            <tr>
                                <td><strong>Relative Velocity (km/s)</strong></td>
                                <td id="velocityA">-</td>
                                <td id="velocityB">-</td>
                                <td id="velocityC" style="display: none;">-</td>
                            </tr>
                            <tr>
                                <td><strong>Absolute Magnitude (H)</strong></td>
                                <td id="hA">-</td>
                                <td id="hB">-</td>
                                <td id="hC" style="display: none;">-</td>
                            </tr>
                            <tr>
                                <td><strong>Observations Used</strong></td>
                                <td id="obsA">-</td>
                                <td id="obsB">-</td>
                                <td id="obsC" style="display: none;">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Orbital Elements Comparison -->
            <div class="comparison-section">
                <h2>Orbital Elements</h2>
                <div class="comparison-table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Element</th>
                                <th>Asteroid A</th>
                                <th>Asteroid B</th>
                                <th id="orbHeaderC" style="display: none;">Asteroid C</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Semi-major Axis (AU)</strong></td>
                                <td id="aA">-</td>
                                <td id="aB">-</td>
                                <td id="aC" style="display: none;">-</td>
                            </tr>
                            <tr>
                                <td><strong>Eccentricity</strong></td>
                                <td id="eA">-</td>
                                <td id="eB">-</td>
                                <td id="eC" style="display: none;">-</td>
                            </tr>
                            <tr>
                                <td><strong>Inclination (¬∞)</strong></td>
                                <td id="iA">-</td>
                                <td id="iB">-</td>
                                <td id="iC" style="display: none;">-</td>
                            </tr>
                            <tr>
                                <td><strong>Long. Asc. Node (¬∞)</strong></td>
                                <td id="omA">-</td>
                                <td id="omB">-</td>
                                <td id="omC" style="display: none;">-</td>
                            </tr>
                            <tr>
                                <td><strong>Arg. Perihelion (¬∞)</strong></td>
                                <td id="wA">-</td>
                                <td id="wB">-</td>
                                <td id="wC" style="display: none;">-</td>
                            </tr>
                            <tr>
                                <td><strong>Perihelion Distance (AU)</strong></td>
                                <td id="qA">-</td>
                                <td id="qB">-</td>
                                <td id="qC" style="display: none;">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Visual Comparisons -->
            <div class="charts-container">
                <div class="chart-panel">
                    <h2>Threat Comparison</h2>
                    <div id="threatChart"></div>
                </div>

                <div class="chart-panel">
                    <h2>Orbital Characteristics</h2>
                    <div id="orbitalChart"></div>
                </div>

                <div class="chart-panel">
                    <h2>Size & Velocity Comparison</h2>
                    <div id="sizeVelocityChart"></div>
                </div>

                <div class="chart-panel">
                    <h2>Risk Factors</h2>
                    <div id="riskChart"></div>
                </div>
            </div>

            <!-- 3D Orbit Overlay -->
            <div class="comparison-section">
                <h2>3D Orbit Overlay</h2>
                <p style="color:#aaa;margin-bottom:10px;">All selected asteroid orbits rendered in the same heliocentric frame alongside Earth's orbit.</p>
                <div id="orbitOverlayChart" style="height:500px;"></div>
            </div>

            <!-- Impact Energy Comparison -->
            <div class="comparison-section">
                <h2>Impact Energy Comparison</h2>
                <p style="color:#aaa;margin-bottom:10px;">Estimated kinetic energy at Earth impact (assumes 20 km/s if v_rel unavailable, albedo=0.14 for diameter estimate).</p>
                <div id="impactEnergyChart" style="height:300px;"></div>
            </div>
        </div>
    </div>

    <script src="/static/js/comparison.js"></script>
    <script>
    // Auto-load defaults: Apophis, Bennu, Eros
    (async function autoLoad() {
        const defaults = [
            { id: '20099942', slot: 'A' },
            { id: '2101955',  slot: 'B' },
            { id: '2000433',  slot: 'C' }
        ];
        for (const d of defaults) {
            try {
                await selectAsteroid(d.id, d.slot);
            } catch(e) { console.warn('Auto-load failed for', d.id, e); }
        }
        // Trigger compare
        const btn = document.getElementById('compareBtn');
        if (!btn.disabled) btn.click();
    })();

    // Kepler solver for orbit overlay
    function solveKeplerComp(M_deg, e) {
        let M = M_deg * Math.PI / 180;
        let E = M;
        for (let i = 0; i < 50; i++) {
            const dE = (M - E + e * Math.sin(E)) / (1 - e * Math.cos(E));
            E += dE;
            if (Math.abs(dE) < 1e-10) break;
        }
        return E;
    }
    function orbitPoints(a, e, i_deg, om_deg, w_deg, N=120) {
        if (!a || !e) return { x:[], y:[], z:[] };
        const deg = Math.PI/180;
        const i = i_deg*deg, om = om_deg*deg, w = w_deg*deg;
        const xs=[], ys=[], zs=[];
        for (let k=0; k<=N; k++) {
            const M = (k/N)*360;
            const E = solveKeplerComp(M, e);
            const nu = 2*Math.atan2(Math.sqrt(1+e)*Math.sin(E/2), Math.sqrt(1-e)*Math.cos(E/2));
            const r = a*(1-e*Math.cos(E));
            // Perifocal
            const xp = r*Math.cos(nu), yp = r*Math.sin(nu);
            // Ecliptic
            const x = (Math.cos(om)*Math.cos(w)-Math.sin(om)*Math.sin(w)*Math.cos(i))*xp + (-Math.cos(om)*Math.sin(w)-Math.sin(om)*Math.cos(w)*Math.cos(i))*yp;
            const y = (Math.sin(om)*Math.cos(w)+Math.cos(om)*Math.sin(w)*Math.cos(i))*xp + (-Math.sin(om)*Math.sin(w)+Math.cos(om)*Math.cos(w)*Math.cos(i))*yp;
            const z = (Math.sin(w)*Math.sin(i))*xp + (Math.cos(w)*Math.sin(i))*yp;
            xs.push(x); ys.push(y); zs.push(z);
        }
        return { x:xs, y:ys, z:zs };
    }

    // Hook into post-compare to render extra charts
    const origRender = window.renderRiskChart;
    document.getElementById('compareBtn').addEventListener('click', () => {
        setTimeout(renderOrbitOverlay, 300);
        setTimeout(renderImpactEnergy, 300);
    }, true);

    function renderOrbitOverlay() {
        const DARK = { paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(10,10,25,0.95)',
            font:{family:'Orbitron,monospace',color:'#00d4ff',size:11} };
        const colors = ['#ff4444','#00d4ff','#44ff88','#ffaa00'];
        const traces = [];
        // Earth orbit reference
        const earth = orbitPoints(1.000, 0.0167, 0.000, 174.9, 288.1);
        traces.push({ type:'scatter3d', mode:'lines', x:earth.x, y:earth.y, z:earth.z,
            line:{color:'#4488ff',width:2}, name:'Earth', opacity:0.6 });
        // Sun
        traces.push({ type:'scatter3d', mode:'markers', x:[0], y:[0], z:[0],
            marker:{size:8,color:'#ffdd00'}, name:'Sun' });

        const asts = [window.asteroidA, window.asteroidB, window.asteroidC].filter(Boolean);
        asts.forEach((ast, idx) => {
            const oe = ast.orbital_elements || {};
            const a = parseFloat(oe.semi_major_axis||ast.a||0);
            const e = parseFloat(oe.eccentricity||ast.e||0);
            const ii = parseFloat(oe.inclination||ast.i||0);
            const om = parseFloat(oe.longitude_ascending_node||ast.om||0);
            const w  = parseFloat(oe.argument_perihelion||ast.w||0);
            const pts = orbitPoints(a, e, ii, om, w);
            traces.push({ type:'scatter3d', mode:'lines', x:pts.x, y:pts.y, z:pts.z,
                line:{color:colors[idx+1],width:3}, name:ast.name||`SPKID ${ast.spkid}` });
        });
        Plotly.newPlot('orbitOverlayChart', traces, {
            ...DARK, margin:{l:0,r:0,t:20,b:0},
            scene:{ xaxis:{title:'X (AU)',gridcolor:'rgba(0,212,255,0.15)',color:'#00d4ff'},
                    yaxis:{title:'Y (AU)',gridcolor:'rgba(0,212,255,0.15)',color:'#00d4ff'},
                    zaxis:{title:'Z (AU)',gridcolor:'rgba(0,212,255,0.15)',color:'#00d4ff'},
                    bgcolor:'rgba(5,5,20,1)' },
            legend:{font:{color:'#00d4ff'}}
        }, { responsive:true });
    }

    function renderImpactEnergy() {
        const asts = [window.asteroidA, window.asteroidB, window.asteroidC].filter(Boolean);
        const estimateDiam = H => H ? 1329/Math.sqrt(0.14)*Math.pow(10,-0.2*H) : 0;
        const names = [], energies = [], colors2 = [];
        asts.forEach(ast => {
            const H = ast.H || (ast.orbital_elements?.H);
            const dKm = estimateDiam(parseFloat(H)||18);
            const dM = dKm * 1000;
            const rho = 3000; // kg/m¬≥
            const v = (ast.v_rel || 20) * 1000; // m/s
            const vol = (4/3)*Math.PI*Math.pow(dM/2,3);
            const mass = rho * vol;
            const ke_J = 0.5 * mass * v * v;
            const ke_Mt = ke_J / 4.184e15;
            names.push(ast.name || `SPKID ${ast.spkid}`);
            energies.push(ke_Mt);
            colors2.push(ke_Mt > 1000 ? '#ff0000' : ke_Mt > 10 ? '#ffaa00' : '#00d4ff');
        });
        // Add historical references
        names.push('Tunguska (1908)', 'Chicxulub (66Ma)');
        energies.push(10, 1e8);
        colors2.push('rgba(100,100,100,0.7)', 'rgba(80,0,80,0.7)');

        Plotly.newPlot('impactEnergyChart', [{
            type:'bar', x:names, y:energies,
            marker:{ color:colors2, line:{color:'#00d4ff',width:1} },
            text: energies.map(e => e >= 1e6 ? (e/1e6).toFixed(1)+'Gt' : e >= 1e3 ? (e/1e3).toFixed(1)+'Gt' : e.toFixed(2)+'Mt'),
            textposition:'outside',
            hovertemplate:'%{x}<br>%{y:.2e} Mt TNT<extra></extra>'
        }], {
            paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(10,10,25,0.95)',
            font:{family:'Orbitron,monospace',color:'#00d4ff',size:11},
            margin:{l:60,r:20,t:20,b:80},
            yaxis:{ type:'log', title:'Energy (Mt TNT)', gridcolor:'rgba(0,212,255,0.1)', color:'#00d4ff' },
            xaxis:{ gridcolor:'rgba(0,212,255,0.1)', color:'#00d4ff' }
        }, { responsive:true });
    }
    </script>
</body>
</html>
